{% load static %}
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyCraft - Cadastro de Trilhas</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <img src="{% static 'images/logo_sc2.png' %}" alt="Logo StudyCraft" class="logo-small">
            <nav>
                <ul>
                    <li><a href="{% url 'dashboard_admin' %}"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="{% url 'cadastro_professor' %}"><i class="fas fa-chalkboard-teacher"></i> Professores</a></li>
                    <li><a href="{% url 'cadastro_aluno' %}"><i class="fas fa-user-graduate"></i> Alunos</a></li>
                    <li><a href="{% url 'cadastro_trilha' %}" class="active"><i class="fas fa-project-diagram"></i> Trilhas</a></li>
                </ul>
            </nav>
            <button class="btn" onclick="sairDoPainel()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </aside>

        <main class="content">
            <h1><i class="fas fa-project-diagram"></i> Criar Trilha Educacional</h1>

            <form id="form-trilha">
                <div class="form-group">
                    <label for="nome"><i class="fas fa-book"></i> Nome da Trilha:</label>
                    <input type="text" id="nome" required placeholder="Ex: Matemática Avançada">
                </div>
                <div class="form-group">
                    <label for="disciplina"><i class="fas fa-graduation-cap"></i> Disciplina:</label>
                    <input type="text" id="disciplina" required placeholder="Ex: Matemática">
                </div>
                <div class="form-group">
                    <label for="professor"><i class="fas fa-chalkboard-teacher"></i> Professor Responsável:</label>
                    <select id="professor" required></select>
                </div>
                <div class="form-group">
                    <label for="alunos"><i class="fas fa-users"></i> Alunos Participantes:</label>
                    <select id="alunos" class="alunos-select" multiple="multiple"></select>
                </div>
                <div class="form-group">
                    <label for="descricao"><i class="fas fa-align-left"></i> Descrição:</label>
                    <textarea id="descricao" rows="3" placeholder="Objetivos da trilha..."></textarea>
                </div>
                <button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Criar Trilha</button>
            </form>

            <div class="tabela-container">
                <h2><i class="fas fa-list"></i> Trilhas Cadastradas</h2>
                <table id="tabela-trilhas">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Disciplina</th>
                            <th>Professor</th>
                            <th>Alunos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4">Carregando trilhas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'js/admin.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Você precisa estar logado!');
                window.location.href = '../login/admin.html';
                return;
            }

            $('.alunos-select').select2({
                placeholder: "Selecione os alunos",
                width: '100%'
            });

            const professorSelect = document.getElementById('professor');
            const alunosSelect = document.getElementById('alunos');
            const tabela = document.querySelector('#tabela-trilhas tbody');
            const form = document.getElementById('form-trilha');

            function carregarProfessores() {
                fetch('http://127.0.0.1:8000/api/professores/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(data => {
                    professorSelect.innerHTML = '';
                    data.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.nome} (${p.disciplina})`;
                        professorSelect.appendChild(opt);
                    });
                });
            }

            function carregarAlunos() {
                fetch('http://127.0.0.1:8000/api/alunos/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(data => {
                    alunosSelect.innerHTML = '';
                    data.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        opt.textContent = `${a.nome} (${a.turma})`;
                        alunosSelect.appendChild(opt);
                    });
                });
            }

            function carregarTrilhas() {
                fetch('http://127.0.0.1:8000/api/trilhas/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(data => {
                    tabela.innerHTML = '';
                    data.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${t.nome}</td>
                            <td>${t.disciplina}</td>
                            <td>${t.professor.nome}</td>
                            <td>${t.alunos.map(a => a.nome).join(', ')}</td>
                        `;
                        tabela.appendChild(tr);
                    });
                })
                .catch(() => {
                    tabela.innerHTML = '<tr><td colspan="4">Erro ao carregar trilhas.</td></tr>';
                });
            }

            form.addEventListener('submit', e => {
                e.preventDefault();
                const nome = document.getElementById('nome').value;
                const disciplina = document.getElementById('disciplina').value;
                const professor = professorSelect.value;
                const alunos = Array.from(alunosSelect.selectedOptions).map(opt => opt.value);
                const descricao = document.getElementById('descricao').value;

                fetch('http://127.0.0.1:8000/api/trilhas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ nome, disciplina, professor, alunos, descricao })
                })
                .then(res => {
                    if (res.ok) {
                        alert('Trilha criada com sucesso!');
                        form.reset();
                        carregarTrilhas();
                    } else {
                        alert('Erro ao criar trilha.');
                    }
                });
            });

            carregarProfessores();
            carregarAlunos();
            carregarTrilhas();
        });
    </script>
</body>
</html>
